<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>System Settings</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .setting-input { padding: 10px; margin: 10px 0; border-radius: 5px; border: none; width: 250px; color: #000; display: block; }
        .setting-btn { margin-top: 10px; display: inline-block; width: 250px; text-align: center; }
        .status-msg { margin-top: 15px; font-size: 0.9em; font-weight: bold; }
    </style>
</head>
<body>
<script src="config.js"></script>

<div class="floating-shape shape1"></div>
<div class="floating-shape shape2"></div>
<div class="floating-shape shape3"></div>

<div class="alerts-container fade-in">
    <h1 class="title">‚öôÔ∏è System Settings</h1>
    <p class="subtitle">Manage real-time fraud detection parameters and global preferences.</p>

    <!-- Threshold Card -->
    <div class="alert-card slide-up" id="threshold-card">
        <h3>üìà Fraud Prediction Threshold (FR-13)</h3>
        <p><strong>Current:</strong> <span id="currentThreshold">Fetching...</span></p>
        <p>Set a value (0.0 - 1.0) to tune sensitivity.</p>
        <input type="number" id="newThreshold" min="0.0" max="1.0" step="0.01" value="0.5" class="setting-input">
        <button class="btn setting-btn" onclick="updateSetting('fraud_threshold', document.getElementById('newThreshold').value, 'statusThreshold')">Update Threshold</button>
        <p id="statusThreshold" class="status-msg"></p>
    </div>

    <!-- Language Card -->
    <div class="alert-card slide-up">
        <h3>üåê Language Preference</h3>
        <p><strong>Current:</strong> <span id="currentLanguage">Fetching...</span></p>
        <select id="newLanguage" class="setting-input">
            <option value="en">English (en)</option>
            <option value="es">Spanish (es)</option>
            <option value="fr">French (fr)</option>
        </select>
        <button class="btn setting-btn" onclick="updateSetting('language', document.getElementById('newLanguage').value, 'statusLanguage')">Update Language</button>
        <p id="statusLanguage" class="status-msg"></p>
    </div>

    <!-- Timezone Card -->
    <div class="alert-card slide-up">
        <h3>‚è∞ Time Zone Preference</h3>
        <p><strong>Current:</strong> <span id="currentTimezone">Fetching...</span></p>
        <input type="text" id="newTimezone" placeholder="e.g., UTC, Europe/London" class="setting-input">
        <button class="btn setting-btn" onclick="updateSetting('timezone', document.getElementById('newTimezone').value, 'statusTimezone')">Update Time Zone</button>
        <p id="statusTimezone" class="status-msg"></p>
    </div>

    <p style="text-align: center; margin-top: 30px;">
        <a href="index.html" class="btn" style="background: #192b4d; color: #00f7ff; box-shadow: 0 0 10px #00f7ff;">‚Üê Back to Dashboard</a>
    </p>
</div>

<script>
function fetchCurrentSettings() {
    fetch(`${API_BASE_URL}/global-settings`, { headers: { 'Authorization': `Bearer ${token}` } })
    .then(r => { if (r.status===401) throw new Error('Unauthorized'); return r.json(); })
    .then(settings => {
        document.getElementById("currentThreshold").textContent = settings.fraud_threshold.toFixed(4);
        document.getElementById("newThreshold").value = settings.fraud_threshold;
        document.getElementById("currentLanguage").textContent = settings.language;
        document.getElementById("newLanguage").value = settings.language;
        document.getElementById("currentTimezone").textContent = settings.timezone;
        document.getElementById("newTimezone").value = settings.timezone;
    })
    .catch(e => {
        if (e.message==='Unauthorized') {
            alert('Session expired.');
            localStorage.removeItem('access_token');
            window.location.href = 'login.html';
        }
        console.error(e);
    });
}

function updateSetting(type, value, statusElementId) {
    const statusMessage = document.getElementById(statusElementId);
    statusMessage.textContent = 'Updating...'; statusMessage.style.color = '#00f7ff';

    if (type==='fraud_threshold') {
        const numValue = parseFloat(value);
        if (isNaN(numValue) || numValue < 0.0 || numValue > 1.0) {
            statusMessage.textContent = "üö® Invalid value. Must be 0.0-1.0"; statusMessage.style.color='red';
            return;
        }
        value = numValue;
    }

    fetch(`${API_BASE_URL}/global-settings`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ [type]: value })
    })
    .then(r => { if(!r.ok) throw new Error('Update failed'); return r.json(); })
    .then(data => { statusMessage.textContent='‚úÖ Updated successfully!'; statusMessage.style.color='#00f7ff'; fetchCurrentSettings(); })
    .catch(e => { statusMessage.textContent='‚ùå Update failed'; statusMessage.style.color='red'; console.error(e); });
}

fetchCurrentSettings();
</script>
</body>
</html>
